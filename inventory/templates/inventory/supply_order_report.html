{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">تقرير طلبات التوريد</h2>
    <form method="get" class="row g-3 mb-4">
        <div class="col-md-2">
            <label class="form-label">من تاريخ</label>
            <input type="date" name="date_from" value="{{ date_from }}" class="form-control">
        </div>
        <div class="col-md-2">
            <label class="form-label">إلى تاريخ</label>
            <input type="date" name="date_to" value="{{ date_to }}" class="form-control">
        </div>
        <div class="col-md-2">
            <label class="form-label">المورد</label>
            <select name="supplier" class="form-select">
                <option value="">الكل</option>
                {% for supplier in suppliers %}
                    <option value="{{ supplier.id }}" {% if supplier.id|stringformat:'s' == selected_supplier %}selected{% endif %}>{{ supplier.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label">المخزن</label>
            <select name="warehouse" class="form-select">
                <option value="">الكل</option>
                {% for warehouse in warehouses %}
                    <option value="{{ warehouse.id }}" {% if warehouse.id|stringformat:'s' == selected_warehouse %}selected{% endif %}>{{ warehouse.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label">الحالة</label>
            <select name="status" class="form-select">
                <option value="">الكل</option>
                <option value="pending" {% if selected_status == 'pending' %}selected{% endif %}>معلق</option>
                <option value="accepted" {% if selected_status == 'accepted' %}selected{% endif %}>تم التنفيذ</option>
                <option value="cancelled" {% if selected_status == 'cancelled' %}selected{% endif %}>ملغي</option>
            </select>
        </div>
        <div class="col-md-2 align-self-end">
            <button type="submit" class="btn btn-primary w-100">تصفية</button>
        </div>
    </form>
    <div class="mb-3 text-end">
        <a href="?export=excel{{ request.GET.urlencode|yesno:'&' }}" class="btn btn-success">
            <i class="fas fa-file-excel"></i> تصدير إلى إكسل
        </a>
    </div>
    <div class="table-responsive">
        <table class="table table-bordered align-middle">
            <thead class="table-light">
                <tr>
                    <th>رقم الطلب</th>
                    <th>التاريخ</th>
                    <th>المورد</th>
                    <th>المخزن</th>
                    <th>الحالة</th>
                    <th>نوع الطلب</th>
                    <th>المنتجات (الكمية المطلوبة/المستلمة)</th>
                    <th>حركات المخزون المرتبطة</th>
                </tr>
            </thead>
            <tbody>
                {% for order in orders %}
                <tr>
                    <td>{{ order.order_number }}</td>
                    <td>{{ order.created_at|date:'Y-m-d' }}</td>
                    <td>{{ order.supplier }}</td>
                    <td>{{ order.from_warehouse }}{% if order.to_warehouse %} → {{ order.to_warehouse }}{% endif %}</td>
                    <td>{{ order.get_status_display }}</td>
                    <td>{{ order.get_order_type_display }}</td>
                    <td>
                        <ul class="mb-0">
                        {% for item in order.items.all %}
                            <li>{{ item.product }} ({{ item.quantity }}/{{ item.delivered_quantity }})</li>
                        {% endfor %}
                        </ul>
                    </td>
                    <td>
                        <ul class="mb-0">
                        {% for tx in order.related_transactions %}
                            <li>{{ tx.get_transaction_type_display }}: {{ tx.product }} ({{ tx.quantity }}) - {{ tx.warehouse }}</li>
                        {% empty %}
                            <li>لا توجد حركات</li>
                        {% endfor %}
                        </ul>
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="8" class="text-center">لا توجد بيانات</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}
