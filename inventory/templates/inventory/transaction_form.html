{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}تسجيل حركة مخزون - {{ product.name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'home' %}">{% trans "الرئيسية" %}</a></li>
            <li class="breadcrumb-item"><a href="{% url 'inventory:product_list' %}">{% trans "المخزون" %}</a></li>
            <li class="breadcrumb-item"><a href="{% url 'inventory:product_detail' product.pk %}">{{ product.name }}</a></li>
            <li class="breadcrumb-item active" aria-current="page">{% trans "تسجيل حركة مخزون" %}</li>
        </ol>
    </nav>

    <div class="card">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0"><i class="fas fa-exchange-alt"></i> {% trans "تسجيل حركة مخزون" %} - {{ product.name }}</h4>
        </div>
        <div class="card-body">
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">{% trans "معلومات المنتج" %}</h5>
                        </div>
                        <div class="card-body">
                            <p><strong>{% trans "الكود:" %}</strong> {{ product.code }}</p>
                            <p><strong>{% trans "الاسم:" %}</strong> {{ product.name }}</p>
                            <p><strong>{% trans "الفئة:" %}</strong> {{ product.category.name }}</p>
                            <p><strong>{% trans "وحدة القياس:" %}</strong> {{ product.get_unit_display }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">{% trans "حالة المخزون" %}</h5>
                        </div>
                        <div class="card-body">
                            <div class="text-center mb-3">
                                <h3>{{ product.current_stock }} {{ product.get_unit_display }}</h3>
                                <p class="mb-0">
                                    {% if product.needs_restock %}
                                        <span class="badge bg-warning">{% trans "منخفض" %}</span>
                                    {% elif product.current_stock <= 0 %}
                                        <span class="badge bg-danger">{% trans "غير متوفر" %}</span>
                                    {% else %}
                                        <span class="badge bg-success">{% trans "متوفر" %}</span>
                                    {% endif %}
                                </p>
                            </div>
                            <div class="progress" style="height: 20px;">
                                {% if product.current_stock <= 0 %}
                                    <div class="progress-bar bg-danger" role="progressbar" style="width: 100%;" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100">
                                        {% trans "غير متوفر" %}
                                    </div>
                                {% elif product.needs_restock %}
                                    <div class="progress-bar bg-warning" role="progressbar" style="width: 50%;" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100">
                                        {% trans "منخفض" %}
                                    </div>
                                {% else %}
                                    <div class="progress-bar bg-success" role="progressbar" style="width: 100%;" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100">
                                        {% trans "متوفر" %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <form method="post" novalidate>
                {% csrf_token %}
                {% if form.non_field_errors %}
                    <div class="alert alert-danger">{{ form.non_field_errors }}</div>
                {% endif %}
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">اسم المنتج</label>
                        <input type="text" class="form-control" value="{{ product.name }}" readonly>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">وحدة القياس</label>
                        <input type="text" class="form-control" value="{{ product.get_unit_display }}" readonly>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-12">
                        {{ form.transaction_type.label_tag }}
                        {{ form.transaction_type }}
                        {% for error in form.transaction_type.errors %}<div class="text-danger">{{ error }}</div>{% endfor %}
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-12">
                        {{ form.reason.label_tag }}
                        {{ form.reason }}
                        {% for error in form.reason.errors %}<div class="text-danger">{{ error }}</div>{% endfor %}
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-12">
                        <label for="id_warehouse" id="warehouse-label">{{ form.warehouse.label }}</label>
                        {{ form.warehouse }}
                        {% for error in form.warehouse.errors %}<div class="text-danger">{{ error }}</div>{% endfor %}
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4">
                        {{ form.quantity.label_tag }}
                        <div class="input-group">
                            {{ form.quantity }}
                            <span class="input-group-text">{{ product.get_unit_display }}</span>
                        </div>
                        {% for error in form.quantity.errors %}<div class="text-danger">{{ error }}</div>{% endfor %}
                    </div>
                    <div class="col-md-4">
                        {{ form.warehouse.label_tag }} <span class="text-danger">*</span>
                        {{ form.warehouse }}
                        {% for error in form.warehouse.errors %}<div class="text-danger">{{ error }}</div>{% endfor %}
                    </div>
                    <div class="col-md-4">
                        {{ form.reference.label_tag }} <span class="text-danger">*</span>
                        {{ form.reference }}
                        {% for error in form.reference.errors %}<div class="text-danger">{{ error }}</div>{% endfor %}
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-12">
                        {{ form.notes.label_tag }}
                        {{ form.notes }}
                        {% for error in form.notes.errors %}<div class="text-danger">{{ error }}</div>{% endfor %}
                    </div>
                </div>
                <div class="d-flex justify-content-end">
                    <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> تسجيل الحركة</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% if form %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var transactionType = document.getElementById('id_transaction_type');
        var warehouseLabel = document.getElementById('warehouse-label');
        function updateWarehouseLabel() {
            if (transactionType && warehouseLabel) {
                if (transactionType.value === 'transfer') {
                    warehouseLabel.textContent = 'إلى';
                } else {
                    warehouseLabel.textContent = 'المخزن';
                }
            }
        }
        if (transactionType) {
            transactionType.addEventListener('change', updateWarehouseLabel);
            updateWarehouseLabel();
        }
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const transactionTypeSelect = document.getElementById('transaction_type');
        const quantityInput = document.getElementById('quantity');
        const currentStock = parseInt('{{ product.current_stock|default:0 }}');
        
        if (transactionTypeSelect && quantityInput) {
            // Add validation for outgoing transactions
            transactionTypeSelect.addEventListener('change', function() {
                if (this.value === 'out') {
                    quantityInput.setAttribute('max', currentStock);
                    // Add validation message
                    let validationMessage = document.createElement('div');
                    validationMessage.className = 'form-text text-danger';
                    validationMessage.id = 'quantity-validation';
                    validationMessage.textContent = '{% trans "الكمية المتاحة للصرف:" %} ' + currentStock;
                    // Remove existing message if any
                    let existingMessage = document.getElementById('quantity-validation');
                    if (existingMessage) {
                        existingMessage.remove();
                    }
                    // Add message after quantity input
                    quantityInput.parentNode.after(validationMessage);
                } else {
                    // Remove max attribute and validation message for incoming transactions
                    quantityInput.removeAttribute('max');
                    let existingMessage = document.getElementById('quantity-validation');
                    if (existingMessage) {
                        existingMessage.remove();
                    }
                }
            });
            // Validate quantity on input
            quantityInput.addEventListener('input', function() {
                if (transactionTypeSelect.value === 'out' && parseInt(this.value) > currentStock) {
                    this.setCustomValidity('{% trans "الكمية المطلوبة أكبر من المخزون المتاح" %}');
                } else {
                    this.setCustomValidity('');
                }
            });
        }
    });
</script>
{% endif %}
{% endblock %}

