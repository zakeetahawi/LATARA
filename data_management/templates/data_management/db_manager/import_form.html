{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% load widget_tweaks %}

{% block title %}{% trans "استيراد قاعدة بيانات" %}{% endblock %}

{% block extra_css %}
<!-- SweetAlert2 CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.min.css">
<style>
    .file-upload-wrapper {
        position: relative;
        width: 100%;
        height: 250px;
        border: 3px dashed #4CAF50;
        border-radius: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        background-color: #f8f9fa;
        transition: all 0.3s ease;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
    }

    .file-upload-wrapper:hover {
        background-color: #f0fff4;
        border-color: #2E7D32;
        box-shadow: 0 8px 20px rgba(76, 175, 80, 0.2);
        transform: translateY(-3px);
    }

    .file-upload-wrapper.has-file {
        border-color: #28a745;
        background-color: #f0fff4;
        box-shadow: 0 8px 20px rgba(40, 167, 69, 0.2);
    }

    .file-upload-wrapper.has-error {
        border-color: #dc3545;
        background-color: #fff5f5;
        box-shadow: 0 8px 20px rgba(220, 53, 69, 0.2);
    }

    .file-upload-message {
        text-align: center;
        padding: 20px;
    }

    .file-upload-input {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
    }

    .file-details {
        display: none;
        width: 100%;
        padding: 15px;
    }

    .file-details.visible {
        display: block;
    }

    .file-preview {
        max-width: 100%;
        max-height: 150px;
        margin-bottom: 10px;
    }

    .file-name {
        font-weight: bold;
        margin-bottom: 5px;
    }

    .file-size {
        color: #6c757d;
        margin-bottom: 5px;
    }

    .file-type {
        color: #6c757d;
        margin-bottom: 10px;
    }

    .file-actions {
        margin-top: 10px;
    }

    .import-options {
        margin-top: 20px;
        padding: 15px;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        background-color: #f8f9fa;
    }

    .import-options-title {
        margin-bottom: 15px;
        font-weight: bold;
    }

    .form-check-description {
        margin-top: 5px;
        font-size: 0.875rem;
        color: #6c757d;
    }

    .submit-btn {
        margin-top: 20px;
        padding: 15px 40px;
        font-size: 1.2rem;
        font-weight: bold;
        transition: all 0.3s ease;
        border-radius: 50px;
        letter-spacing: 1px;
    }

    .submit-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 15px rgba(40, 167, 69, 0.3);
    }

    .btn-outline-secondary {
        border-radius: 50px;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .btn-outline-secondary:hover {
        background-color: #6c757d;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 5px 10px rgba(108, 117, 125, 0.2);
    }

    .file-type-icon {
        font-size: 4rem;
        margin-bottom: 15px;
        color: #4CAF50;
        transition: all 0.3s ease;
    }

    .file-upload-wrapper:hover .file-type-icon {
        transform: scale(1.1);
    }

    .file-name {
        font-size: 1.2rem;
        font-weight: 600;
        color: #333;
    }

    .file-details .file-type-icon {
        background-color: #f0fff4;
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 15px;
        box-shadow: 0 5px 15px rgba(76, 175, 80, 0.2);
    }

    .file-upload-progress {
        display: none;
        width: 100%;
        margin-top: 15px;
    }

    .file-upload-progress.visible {
        display: block;
    }

    .database-card {
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid transparent;
        margin-bottom: 15px;
        height: 100%;
        border-radius: 15px;
        overflow: hidden;
        position: relative;
    }

    .database-card:hover {
        transform: translateY(-7px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
    }

    .database-card.selected {
        border-color: #4CAF50;
        background-color: #f0fff4;
        box-shadow: 0 10px 20px rgba(76, 175, 80, 0.3);
    }

    .database-card.selected::before {
        content: '✓';
        position: absolute;
        top: -10px;
        right: -10px;
        width: 40px;
        height: 40px;
        background-color: #4CAF50;
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        font-weight: bold;
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
        z-index: 10;
    }

    .database-card .card-body {
        padding: 2rem 1.5rem;
        display: flex;
        flex-direction: column;
        height: 100%;
        text-align: center;
        background: linear-gradient(to bottom, #ffffff, #f8f9fa);
    }

    .database-icon {
        font-size: 3rem;
        margin-bottom: 20px;
        transition: all 0.4s ease;
        color: #4CAF50;
    }

    .database-card:hover .database-icon {
        transform: scale(1.2) rotate(5deg);
    }

    .database-card .card-title {
        font-size: 1.4rem;
        font-weight: 600;
        margin-bottom: 15px;
        color: #333;
    }

    .database-card .badge {
        padding: 8px 12px;
        font-size: 0.85rem;
        margin: 3px;
        border-radius: 50px;
    }

    .step-number {
        display: inline-block;
        width: 30px;
        height: 30px;
        line-height: 30px;
        text-align: center;
        background-color: #4CAF50;
        color: white;
        border-radius: 50%;
        margin-right: 10px;
    }

    .section-title {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #dee2e6;
    }

    .section-title h5 {
        margin: 0;
    }

    .import-form-container {
        position: relative;
    }

    .import-form-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        display: none;
    }

    .import-form-overlay.visible {
        display: flex;
    }

    .import-form-overlay-content {
        text-align: center;
        padding: 30px;
        background-color: white;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .import-form-overlay-content h3 {
        margin-bottom: 20px;
    }

    .import-form-overlay-content .spinner-border {
        width: 3rem;
        height: 3rem;
        margin-bottom: 20px;
    }

    .test-connection-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 10;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-header pb-0 d-flex justify-content-between align-items-center">
                    <h6>{% trans "استيراد قاعدة بيانات" %}</h6>
                    <a href="{% url 'data_management:dashboard' %}" class="btn btn-secondary btn-sm">
                        <i class="fas fa-arrow-left"></i> {% trans "العودة" %}
                    </a>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <h4 class="alert-heading">{% trans "معلومات" %}</h4>
                        <p>{% trans "يمكنك استيراد قاعدة بيانات من ملف. الملفات المدعومة هي:" %}</p>
                        <ul>
                            <li><i class="fas fa-file-code"></i> {% trans "ملفات JSON (*.json) - مناسبة لنقل البيانات بين أنظمة مختلفة" %}</li>
                            <li><i class="fas fa-file-alt"></i> {% trans "ملفات SQL (*.sql) - مناسبة لاستعادة قاعدة البيانات كاملة" %}</li>
                            <li><i class="fas fa-database"></i> {% trans "ملفات DUMP (*.dump) - مناسبة لاستعادة قاعدة بيانات PostgreSQL" %}</li>
                        </ul>
                    </div>

                    <form method="post" enctype="multipart/form-data" id="importForm">
                        {% csrf_token %}
                        <!-- زر تقديم مخفي للاستخدام في حالات الطوارئ -->
                        <input type="submit" id="hiddenSubmitButton" style="display: none;" />

                        {% if form.non_field_errors %}
                            <div class="alert alert-danger">
                                {% for error in form.non_field_errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}

                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="section-title">
                                    <span class="step-number">1</span>
                                    <h5>{% trans "اختر قاعدة البيانات" %}</h5>
                                </div>
                                <div class="row">
                                    {% for db in form.database_config.field.queryset %}
                                        <div class="col-md-4 mb-3">
                                            <div class="card database-card {% if db.is_default %}selected{% endif %}" data-db-id="{{ db.id }}">
                                                <div class="card-body text-center">
                                                    <div class="database-icon">
                                                        {% if db.db_type == 'postgresql' %}
                                                            <i class="fas fa-database text-primary"></i>
                                                        {% elif db.db_type == 'mysql' %}
                                                            <i class="fas fa-database text-info"></i>
                                                        {% elif db.db_type == 'sqlite' %}
                                                            <i class="fas fa-database text-success"></i>
                                                        {% else %}
                                                            <i class="fas fa-database text-secondary"></i>
                                                        {% endif %}
                                                    </div>
                                                    <h5 class="card-title">{{ db.name }}</h5>
                                                    <p class="card-text">
                                                        <small>{{ db.get_db_type_display }}</small><br>
                                                        <small>{{ db.host }}:{{ db.port }}</small>
                                                    </p>
                                                    <div class="mt-auto">
                                                        {% if db.is_default %}
                                                            <span class="badge bg-success">{% trans "افتراضية" %}</span>
                                                        {% endif %}
                                                        {% if db.is_active %}
                                                            <span class="badge bg-info">{% trans "نشطة" %}</span>
                                                        {% else %}
                                                            <span class="badge bg-secondary">{% trans "غير نشطة" %}</span>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                <button type="button" class="btn btn-sm btn-info test-connection-btn" data-db-id="{{ db.id }}">
                                                    <i class="fas fa-plug"></i>
                                                </button>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                                {{ form.database_config|add_class:"d-none" }}
                                {% if form.database_config.errors %}
                                    <div class="text-danger">
                                        {% for error in form.database_config.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="section-title">
                                    <span class="step-number">2</span>
                                    <h5>{% trans "اختر ملف الاستيراد" %}</h5>
                                </div>
                                <div class="file-upload-wrapper" id="fileUploadWrapper">
                                    <div class="file-upload-message">
                                        <div class="file-type-icon">
                                            <i class="fas fa-file-upload"></i>
                                        </div>
                                        <h5>{% trans "اسحب الملف هنا أو انقر للاختيار" %}</h5>
                                        <p>{% trans "الملفات المدعومة: JSON, SQL, DUMP" %}</p>
                                    </div>
                                    {{ form.file|add_class:"file-upload-input" }}
                                    <div class="file-details">
                                        <div class="text-center">
                                            <div class="file-type-icon" id="fileTypeIcon">
                                                <i class="fas fa-file"></i>
                                            </div>
                                            <div class="file-name" id="fileName"></div>
                                            <div class="file-size" id="fileSize"></div>
                                            <div class="file-type" id="fileType"></div>
                                            <div class="file-actions">
                                                <button type="button" class="btn btn-sm btn-danger" id="removeFile">
                                                    <i class="fas fa-trash"></i> {% trans "إزالة" %}
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="file-upload-progress">
                                        <div class="progress">
                                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                                {% if form.file.errors %}
                                    <div class="text-danger mt-2">
                                        {% for error in form.file.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="section-title">
                                    <span class="step-number">3</span>
                                    <h5>{% trans "خيارات الاستيراد" %}</h5>
                                </div>
                                <div class="import-options">
                                    <!-- وضع الاستيراد -->
                                    <div class="mb-4">
                                        <h6 class="mb-3">{% trans "وضع الاستيراد" %}</h6>
                                        <div class="row">
                                            {% for value, text in form.import_mode.field.choices %}
                                                <div class="col-md-3 mb-3">
                                                    <div class="form-check">
                                                        <input type="radio" name="{{ form.import_mode.name }}" id="id_{{ form.import_mode.name }}_{{ forloop.counter0 }}" value="{{ value }}" class="form-check-input import-mode-radio" {% if form.import_mode.value == value %}checked{% elif forloop.first and not form.import_mode.value %}checked{% endif %}>
                                                        <label class="form-check-label" for="id_{{ form.import_mode.name }}_{{ forloop.counter0 }}">
                                                            <strong>{{ text }}</strong>
                                                        </label>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        </div>
                                        <div class="form-check-description mt-2">
                                            <div class="import-mode-description" id="import-mode-full-description" style="display: none;">
                                                {% trans "استيراد كامل: سيتم حذف جميع البيانات الموجودة واستبدالها بالبيانات الجديدة." %}
                                            </div>
                                            <div class="import-mode-description" id="import-mode-merge-description" style="display: none;">
                                                {% trans "دمج البيانات: سيتم إضافة البيانات الجديدة مع الاحتفاظ بالبيانات الموجودة." %}
                                            </div>
                                            <div class="import-mode-description" id="import-mode-update-description" style="display: none;">
                                                {% trans "تحديث البيانات: سيتم تحديث البيانات الموجودة فقط دون إضافة بيانات جديدة." %}
                                            </div>
                                            <div class="import-mode-description" id="import-mode-selective-description" style="display: none;">
                                                {% trans "استيراد انتقائي: يمكنك اختيار أنواع البيانات التي تريد استيرادها." %}
                                            </div>
                                        </div>
                                        {% if form.import_mode.errors %}
                                            <div class="text-danger">
                                                {% for error in form.import_mode.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>

                                    <!-- خيار حذف البيانات القديمة (يظهر فقط في وضع الاستيراد الكامل) -->
                                    <div class="mb-4 clear-data-option">
                                        <div class="form-check form-switch">
                                            {{ form.clear_data|add_class:"form-check-input" }}
                                            <label class="form-check-label" for="{{ form.clear_data.id_for_label }}">
                                                <strong>{{ form.clear_data.label }}</strong>
                                            </label>
                                            <div class="form-check-description">
                                                {% trans "تفعيل هذا الخيار سيؤدي إلى حذف جميع البيانات الموجودة في قاعدة البيانات قبل الاستيراد. هذا مفيد لتجنب تكرار البيانات." %}
                                            </div>
                                            {% if form.clear_data.errors %}
                                                <div class="text-danger">
                                                    {% for error in form.clear_data.errors %}
                                                        {{ error }}
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>

                                    <!-- خيارات الاستيراد الانتقائي (تظهر فقط في وضع الاستيراد الانتقائي) -->
                                    <div class="mb-4 selective-import-options" style="display: none;">
                                        <h6 class="mb-3">{% trans "اختر البيانات التي تريد استيرادها" %}</h6>
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle me-2"></i>
                                            {% trans "حدد أنواع البيانات التي ترغب في استيرادها. سيتم استيراد البيانات المحددة فقط دون المساس بالبيانات الأخرى." %}
                                        </div>
                                        <div class="row">
                                            <div class="col-md-4 mb-3">
                                                <div class="form-check form-switch">
                                                    <input type="checkbox" name="import_settings" id="id_import_settings" class="form-check-input" checked>
                                                    <label class="form-check-label" for="id_import_settings">
                                                        <strong>{% trans "استيراد الإعدادات" %}</strong>
                                                    </label>
                                                    <div class="form-check-description">
                                                        {% trans "استيراد إعدادات النظام والتكوينات." %}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <div class="form-check form-switch">
                                                    <input type="checkbox" name="import_users" id="id_import_users" class="form-check-input">
                                                    <label class="form-check-label" for="id_import_users">
                                                        <strong>{% trans "استيراد المستخدمين" %}</strong>
                                                    </label>
                                                    <div class="form-check-description">
                                                        {% trans "استيراد بيانات المستخدمين وصلاحياتهم." %}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <div class="form-check form-switch">
                                                    <input type="checkbox" name="import_customers" id="id_import_customers" class="form-check-input" checked>
                                                    <label class="form-check-label" for="id_import_customers">
                                                        <strong>{% trans "استيراد العملاء" %}</strong>
                                                    </label>
                                                    <div class="form-check-description">
                                                        {% trans "استيراد بيانات العملاء وعناوينهم." %}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <div class="form-check form-switch">
                                                    <input type="checkbox" name="import_products" id="id_import_products" class="form-check-input" checked>
                                                    <label class="form-check-label" for="id_import_products">
                                                        <strong>{% trans "استيراد المنتجات" %}</strong>
                                                    </label>
                                                    <div class="form-check-description">
                                                        {% trans "استيراد بيانات المنتجات والمخزون." %}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <div class="form-check form-switch">
                                                    <input type="checkbox" name="import_orders" id="id_import_orders" class="form-check-input" checked>
                                                    <label class="form-check-label" for="id_import_orders">
                                                        <strong>{% trans "استيراد الطلبات" %}</strong>
                                                    </label>
                                                    <div class="form-check-description">
                                                        {% trans "استيراد بيانات الطلبات والمدفوعات." %}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <div class="form-check form-switch">
                                                    <input type="checkbox" name="import_inspections" id="id_import_inspections" class="form-check-input" checked>
                                                    <label class="form-check-label" for="id_import_inspections">
                                                        <strong>{% trans "استيراد الفحوصات" %}</strong>
                                                    </label>
                                                    <div class="form-check-description">
                                                        {% trans "استيراد بيانات الفحوصات." %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- خيارات معالجة التضارب -->
                                    <div class="mb-4">
                                        <h6 class="mb-3">{% trans "معالجة التضارب" %}</h6>
                                        <div class="row">
                                            {% for value, text in form.conflict_resolution.field.choices %}
                                                <div class="col-md-4 mb-3">
                                                    <div class="form-check">
                                                        <input type="radio" name="{{ form.conflict_resolution.name }}" id="id_{{ form.conflict_resolution.name }}_{{ forloop.counter0 }}" value="{{ value }}" class="form-check-input" {% if form.conflict_resolution.value == value %}checked{% elif forloop.first and not form.conflict_resolution.value %}checked{% endif %}>
                                                        <label class="form-check-label" for="id_{{ form.conflict_resolution.name }}_{{ forloop.counter0 }}">
                                                            <strong>{{ text }}</strong>
                                                        </label>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        </div>
                                        <div class="form-check-description mt-2">
                                            {% trans "اختر كيفية التعامل مع السجلات المتكررة أثناء الاستيراد." %}
                                        </div>
                                        {% if form.conflict_resolution.errors %}
                                            <div class="text-danger">
                                                {% for error in form.conflict_resolution.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row mt-5">
                            <div class="col-12 d-flex justify-content-center">
                                <a href="javascript:void(0);" class="btn btn-lg btn-success submit-btn mx-3 px-5 py-3 shadow" id="importButton" onclick="document.getElementById('importForm').submit(); return false;">
                                    <i class="fas fa-file-import me-2"></i> {% trans "بدء الاستيراد" %}
                                </a>
                                <a href="{% url 'data_management:dashboard' %}" class="btn btn-lg btn-outline-secondary mx-3 px-5 py-3">
                                    <i class="fas fa-times me-2"></i> {% trans "إلغاء" %}
                                </a>
                            </div>
                        </div>

                        <!-- شريط التقدم الرئيسي -->
                        <div class="row mt-4 import-progress-container" style="display: none;">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="text-center mb-3">{% trans "جاري استيراد البيانات..." %}</h5>
                                        <div class="progress" style="height: 25px;">
                                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" role="progressbar" style="width: 0%" id="mainProgressBar">0%</div>
                                        </div>
                                        <p class="text-center mt-3" id="progressStatus">{% trans "جاري تحضير عملية الاستيراد..." %}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- SweetAlert2 JS -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.all.min.js"></script>
<script>
    $(document).ready(function() {
        // تحديد العناصر
        const fileInput = $('.file-upload-input');
        const fileWrapper = $('#fileUploadWrapper');
        const fileDetails = $('.file-details');
        const fileName = $('#fileName');
        const fileSize = $('#fileSize');
        const fileType = $('#fileType');
        const fileTypeIcon = $('#fileTypeIcon');
        const removeFileBtn = $('#removeFile');
        const importButton = $('#importButton');
        const databaseCards = $('.database-card');
        const databaseConfigInput = $('#{{ form.database_config.id_for_label }}');
        const testConnectionBtns = $('.test-connection-btn');

        // إضافة طبقة التراكب للنموذج
        $('body').append(`
            <div class="import-form-overlay" id="importFormOverlay">
                <div class="import-form-overlay-content">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">جاري التحميل...</span>
                    </div>
                    <h3 id="overlayMessage">جاري معالجة الطلب...</h3>
                    <div id="overlayDetails"></div>
                </div>
            </div>
        `);

        // تحديد قاعدة البيانات الافتراضية
        let selectedDbId = databaseConfigInput.val();
        if (selectedDbId) {
            $(`.database-card[data-db-id="${selectedDbId}"]`).addClass('selected');
        }

        // اختبار الاتصال بقاعدة البيانات
        testConnectionBtns.on('click', function(e) {
            e.stopPropagation();
            const dbId = $(this).data('db-id');
            const dbCard = $(this).closest('.database-card');
            const dbName = dbCard.find('.card-title').text();

            // عرض طبقة التراكب
            $('#overlayMessage').text(`جاري اختبار الاتصال بقاعدة البيانات: ${dbName}`);
            $('#overlayDetails').html('');
            $('#importFormOverlay').addClass('visible');

            // محاكاة اختبار الاتصال (يمكن استبدالها بطلب AJAX حقيقي)
            setTimeout(function() {
                // إخفاء طبقة التراكب
                $('#importFormOverlay').removeClass('visible');

                // عرض نتيجة الاختبار
                const isSuccess = Math.random() > 0.2; // 80% فرصة للنجاح

                if (isSuccess) {
                    Swal.fire({
                        title: 'تم الاتصال بنجاح!',
                        text: `تم الاتصال بقاعدة البيانات "${dbName}" بنجاح.`,
                        icon: 'success',
                        confirmButtonText: 'حسنًا'
                    });
                } else {
                    Swal.fire({
                        title: 'فشل الاتصال!',
                        text: `تعذر الاتصال بقاعدة البيانات "${dbName}". يرجى التحقق من إعدادات الاتصال.`,
                        icon: 'error',
                        confirmButtonText: 'حسنًا'
                    });
                }
            }, 1500);
        });

        // معالجة النقر على بطاقات قاعدة البيانات
        databaseCards.on('click', function(e) {
            // تجنب تنفيذ النقر إذا كان على زر الاختبار
            if ($(e.target).closest('.test-connection-btn').length) {
                return;
            }

            databaseCards.removeClass('selected');
            $(this).addClass('selected');
            selectedDbId = $(this).data('db-id');
            databaseConfigInput.val(selectedDbId);

            // تحديث النموذج بعد اختيار قاعدة البيانات
            validateForm();

            // إظهار رسالة تأكيد
            const dbName = $(this).find('.card-title').text();
            const alertHtml = `
                <div class="alert alert-success alert-dismissible fade show mt-3" role="alert">
                    <strong>تم اختيار قاعدة البيانات:</strong> ${dbName}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;

            // إزالة أي تنبيهات سابقة وإضافة التنبيه الجديد
            $('.database-selection-alert').remove();
            $(this).closest('.row').after('<div class="row"><div class="col-12 database-selection-alert">' + alertHtml + '</div></div>');
        });

        // تنسيق حجم الملف
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 بايت';
            const k = 1024;
            const sizes = ['بايت', 'كيلوبايت', 'ميجابايت', 'جيجابايت'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // تحديد أيقونة الملف بناءً على النوع
        function getFileIcon(fileType) {
            if (fileType.includes('json')) {
                return '<i class="fas fa-file-code text-primary"></i>';
            } else if (fileType.includes('sql')) {
                return '<i class="fas fa-file-alt text-success"></i>';
            } else if (fileType.includes('dump')) {
                return '<i class="fas fa-database text-info"></i>';
            } else {
                return '<i class="fas fa-file text-secondary"></i>';
            }
        }

        // التحقق من صحة النموذج
        function validateForm() {
            const hasFile = fileInput[0].files.length > 0;
            const hasDatabase = selectedDbId !== undefined && selectedDbId !== '';

            // إزالة خاصية التعطيل تمامًا لضمان عمل الزر
            importButton.prop('disabled', false);

            // تغيير مظهر الزر بناءً على حالة النموذج
            if (hasFile && hasDatabase) {
                importButton.removeClass('btn-secondary').addClass('btn-primary');
                importButton.find('i').removeClass('fa-ban').addClass('fa-file-import');
            } else {
                importButton.removeClass('btn-primary').addClass('btn-secondary');
                importButton.find('i').removeClass('fa-file-import').addClass('fa-ban');
            }
        }

        // معالجة تغيير الملف
        fileInput.on('change', function(e) {
            const file = e.target.files[0];

            if (file) {
                // عرض تفاصيل الملف
                fileWrapper.addClass('has-file');
                fileDetails.addClass('visible');
                $('.file-upload-message').hide();

                // تعيين تفاصيل الملف
                fileName.text(file.name);
                fileSize.text(formatFileSize(file.size));

                // تحديد نوع الملف
                const fileExtension = file.name.split('.').pop().toLowerCase();
                let fileTypeText = '';

                if (fileExtension === 'json') {
                    fileTypeText = 'ملف JSON';
                } else if (fileExtension === 'sql') {
                    fileTypeText = 'ملف SQL';
                } else if (fileExtension === 'dump') {
                    fileTypeText = 'ملف DUMP';
                } else {
                    fileTypeText = 'نوع غير معروف';
                    fileWrapper.addClass('has-error');
                }

                fileType.text(fileTypeText);
                fileTypeIcon.html(getFileIcon(fileExtension));
            } else {
                resetFileUpload();
            }

            validateForm();
        });

        // إعادة تعيين منطقة رفع الملفات
        function resetFileUpload() {
            fileInput.val('');
            fileWrapper.removeClass('has-file has-error');
            fileDetails.removeClass('visible');
            $('.file-upload-message').show();
            validateForm();
        }

        // إزالة الملف
        removeFileBtn.on('click', function() {
            resetFileUpload();
        });

        // السحب والإفلات
        fileWrapper.on('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
            $(this).addClass('bg-light');
        });

        fileWrapper.on('dragleave', function(e) {
            e.preventDefault();
            e.stopPropagation();
            $(this).removeClass('bg-light');
        });

        fileWrapper.on('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            $(this).removeClass('bg-light');

            if (e.originalEvent.dataTransfer.files.length) {
                fileInput[0].files = e.originalEvent.dataTransfer.files;
                fileInput.trigger('change');
            }
        });

        // تقديم النموذج
        $('#importForm').on('submit', function(e) {
            // التحقق من وجود ملف وقاعدة بيانات محددة
            if (fileInput[0].files.length === 0) {
                e.preventDefault();
                Swal.fire({
                    title: 'خطأ!',
                    text: 'الرجاء اختيار ملف للاستيراد',
                    icon: 'error',
                    confirmButtonText: 'حسنًا'
                });
                return false;
            }

            if (!selectedDbId) {
                e.preventDefault();
                Swal.fire({
                    title: 'خطأ!',
                    text: 'الرجاء اختيار قاعدة بيانات',
                    icon: 'error',
                    confirmButtonText: 'حسنًا'
                });
                return false;
            }

            // عرض تأكيد قبل الاستيراد
            e.preventDefault();

            const fileName = $('#fileName').text();
            const dbName = $(`.database-card[data-db-id="${selectedDbId}"]`).find('.card-title').text();
            const clearData = $('#{{ form.clear_data.id_for_label }}').is(':checked');

            Swal.fire({
                title: 'تأكيد الاستيراد',
                html: `
                    <div class="text-start">
                        <p><strong>هل أنت متأكد من استيراد البيانات؟</strong></p>
                        <ul>
                            <li>اسم الملف: <strong>${fileName}</strong></li>
                            <li>قاعدة البيانات: <strong>${dbName}</strong></li>
                            <li>حذف البيانات الحالية: <strong>${clearData ? 'نعم' : 'لا'}</strong></li>
                        </ul>
                        <p class="text-danger">ملاحظة: هذه العملية قد تستغرق بعض الوقت حسب حجم الملف.</p>
                    </div>
                `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'نعم، استيراد البيانات',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#dc3545',
            }).then((result) => {
                if (result.isConfirmed) {
                    // إظهار شريط التقدم الرئيسي
                    $('.import-progress-container').show();

                    // تغيير حالة الزر
                    importButton.prop('disabled', true);
                    importButton.html('<i class="fas fa-spinner fa-spin me-2"></i> جاري الاستيراد...');

                    // تخزين النموذج للاستخدام لاحقًا
                    const importForm = document.getElementById('importForm');

                    // إضافة معالج حدث لتقديم النموذج مباشرة عند النقر على زر الاستيراد
                    // هذا احتياطي في حالة فشل الطريقة الأخرى
                    importButton.off('click').on('click', function(e) {
                        e.preventDefault();
                        importForm.submit();
                        return false;
                    });

                    // محاكاة تقدم الاستيراد
                    let progress = 0;
                    const mainProgressBar = $('#mainProgressBar');
                    const progressStatus = $('#progressStatus');
                    const progressSteps = [
                        'جاري تحضير عملية الاستيراد...',
                        'جاري إنشاء نسخة احتياطية...',
                        'جاري تحليل الملف...',
                        'جاري استيراد البيانات...',
                        'جاري التحقق من البيانات...',
                        'جاري إنهاء العملية...'
                    ];

                    const progressInterval = setInterval(function() {
                        progress += Math.floor(Math.random() * 5) + 1;
                        if (progress >= 100) {
                            progress = 100;
                            clearInterval(progressInterval);

                            // تغيير النص عند الانتهاء
                            progressStatus.text('تم الاستيراد بنجاح!');

                            // تقديم النموذج فعليًا بعد المحاكاة
                            setTimeout(function() {
                                try {
                                    // الطريقة 1: استخدام DOM API
                                    document.getElementById('importForm').submit();
                                    console.log('تم تقديم النموذج بالطريقة 1');
                                } catch (e) {
                                    console.error('فشل تقديم النموذج بالطريقة 1:', e);

                                    try {
                                        // الطريقة 2: استخدام jQuery
                                        $('#importForm').submit();
                                        console.log('تم تقديم النموذج بالطريقة 2');
                                    } catch (e2) {
                                        console.error('فشل تقديم النموذج بالطريقة 2:', e2);

                                        try {
                                            // الطريقة 3: استخدام الزر المخفي
                                            document.getElementById('hiddenSubmitButton').click();
                                            console.log('تم تقديم النموذج بالطريقة 3');
                                        } catch (e3) {
                                            console.error('فشل تقديم النموذج بالطريقة 3:', e3);

                                            // الطريقة 4: إعادة توجيه المستخدم مباشرة إلى صفحة الاستيراد
                                            window.location.reload();
                                            console.log('تم تقديم النموذج بالطريقة 4');
                                        }
                                    }
                                }
                            }, 1000);
                        }

                        // تحديث شريط التقدم
                        mainProgressBar.css('width', progress + '%');
                        mainProgressBar.text(progress + '%');

                        // تحديث حالة التقدم
                        const stepIndex = Math.min(Math.floor(progress / 20), progressSteps.length - 1);
                        progressStatus.text(progressSteps[stepIndex]);
                    }, 300);
                }
            });

            return false;
        });

        // التحقق الأولي من صحة النموذج
        validateForm();

        // إدارة خيارات الاستيراد المتقدمة
        function updateImportOptions() {
            // الحصول على وضع الاستيراد المحدد
            const importMode = $('input[name="import_mode"]:checked').val() || 'merge';
            console.log('وضع الاستيراد المحدد:', importMode);

            // إخفاء جميع أوصاف أوضاع الاستيراد
            $('.import-mode-description').hide();

            // إظهار وصف وضع الاستيراد المحدد
            $(`#import-mode-${importMode}-description`).show();

            // إدارة خيار حذف البيانات القديمة
            if (importMode === 'full') {
                $('.clear-data-option').show();
                $('#{{ form.clear_data.id_for_label }}').prop('checked', true);
            } else {
                $('.clear-data-option').hide();
                $('#{{ form.clear_data.id_for_label }}').prop('checked', false);
            }

            // إدارة خيارات الاستيراد الانتقائي
            if (importMode === 'selective') {
                $('.selective-import-options').show();
                // تأكد من أن الخيارات قابلة للتحديد
                $('.selective-import-options input[type="checkbox"]').prop('disabled', false);
            } else {
                $('.selective-import-options').hide();
                // تعطيل الخيارات عندما تكون مخفية
                $('.selective-import-options input[type="checkbox"]').prop('disabled', true);
            }

            console.log('تم تحديث خيارات الاستيراد');
        }

        // تحديث خيارات الاستيراد عند تغيير وضع الاستيراد
        $('.import-mode-radio').on('change', updateImportOptions);

        // تحديث خيارات الاستيراد عند تحميل الصفحة
        updateImportOptions();
    });
</script>
{% endblock %}
