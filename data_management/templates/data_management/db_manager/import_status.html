{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "حالة استيراد قاعدة البيانات" %}{% endblock %}

{% block extra_css %}
<style>
    .log-container {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        padding: 1rem;
        max-height: 400px;
        overflow-y: auto;
        font-family: monospace;
        white-space: pre-wrap;
        word-wrap: break-word;
    }

    .status-badge {
        font-size: 1rem;
        padding: 0.5rem 1rem;
    }

    .progress {
        height: 20px;
    }

    .progress-bar {
        transition: width 0.5s ease;
    }

    .log-line {
        margin-bottom: 0.25rem;
    }

    .log-line.error {
        color: #dc3545;
    }

    .log-line.success {
        color: #28a745;
    }

    .log-line.warning {
        color: #ffc107;
    }

    .log-line.info {
        color: #17a2b8;
    }

    .refresh-btn {
        cursor: pointer;
    }

    .auto-refresh-toggle {
        cursor: pointer;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-header pb-0 d-flex justify-content-between align-items-center">
                    <h6>{% trans "حالة استيراد قاعدة البيانات" %}</h6>
                    <div>
                        <span class="auto-refresh-toggle me-3">
                            <input type="checkbox" id="autoRefresh" checked>
                            <label for="autoRefresh">{% trans "تحديث تلقائي" %}</label>
                        </span>
                        <a href="#" class="refresh-btn btn btn-sm btn-info me-2">
                            <i class="fas fa-sync-alt"></i> {% trans "تحديث" %}
                        </a>
                        <a href="{% url 'data_management:db_manager:db_dashboard' %}" class="btn btn-secondary btn-sm">
                            <i class="fas fa-arrow-left"></i> {% trans "العودة" %}
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header pb-0">
                                    <h6>{% trans "معلومات الاستيراد" %}</h6>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table">
                                            <tbody>
                                                <tr>
                                                    <td>{% trans "اسم الملف" %}</td>
                                                    <td id="fileName">{{ db_import.file.name|default:"-" }}</td>
                                                </tr>
                                                <tr>
                                                    <td>{% trans "قاعدة البيانات" %}</td>
                                                    <td id="databaseName">{{ db_import.database_config.name }}</td>
                                                </tr>
                                                <tr>
                                                    <td>{% trans "الحالة" %}</td>
                                                    <td>
                                                        <span id="statusBadge" class="badge status-badge">
                                                            {% if db_import.status == 'completed' %}
                                                                <span class="badge bg-success">{% trans "مكتمل" %}</span>
                                                            {% elif db_import.status == 'failed' %}
                                                                <span class="badge bg-danger">{% trans "فشل" %}</span>
                                                            {% elif db_import.status == 'in_progress' %}
                                                                <span class="badge bg-info">{% trans "قيد المعالجة" %}</span>
                                                            {% else %}
                                                                <span class="badge bg-secondary">{% trans "معلق" %}</span>
                                                            {% endif %}
                                                        </span>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>{% trans "تاريخ البدء" %}</td>
                                                    <td id="createdAt">{{ db_import.created_at|date:"Y-m-d H:i:s" }}</td>
                                                </tr>
                                                <tr>
                                                    <td>{% trans "تاريخ الانتهاء" %}</td>
                                                    <td id="completedAt">
                                                        {% if db_import.completed_at %}
                                                            {{ db_import.completed_at|date:"Y-m-d H:i:s" }}
                                                        {% else %}
                                                            -
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header pb-0">
                                    <h6>{% trans "التقدم" %}</h6>
                                </div>
                                <div class="card-body">
                                    <div class="progress mb-3">
                                        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
                                            aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%">
                                            0%
                                        </div>
                                    </div>

                                    <div id="statusMessage" class="alert alert-info">
                                        {% trans "جاري معالجة الاستيراد..." %}
                                    </div>

                                    <div class="mt-3 text-end">
                                        {% if db_import.status == 'completed' %}
                                            <a href="{% url 'data_management:db_manager:db_dashboard' %}" class="btn btn-success">
                                                <i class="fas fa-check"></i> {% trans "العودة إلى لوحة التحكم" %}
                                            </a>
                                        {% elif db_import.status == 'failed' %}
                                            <a href="{% url 'data_management:db_import' %}" class="btn btn-primary">
                                                <i class="fas fa-redo"></i> {% trans "محاولة مرة أخرى" %}
                                            </a>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header pb-0">
                                    <h6>{% trans "سجل العملية" %}</h6>
                                </div>
                                <div class="card-body">
                                    <div id="logContainer" class="log-container">
                                        {% if db_import.log %}
                                            {{ db_import.log|linebreaks }}
                                        {% else %}
                                            {% trans "جاري تحميل السجل..." %}
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // تعريف المتغيرات
        const importId = {{ db_import.id }};
        let autoRefresh = true;
        let refreshInterval;
        let currentStatus = "{{ db_import.status }}";

        // تحديث حالة الاستيراد
        function updateImportStatus() {
            $.ajax({
                url: "{% url 'data_management:db_manager:import_status' pk=db_import.id %}",
                type: "GET",
                dataType: "json",
                headers: {
                    "X-Requested-With": "XMLHttpRequest"
                },
                success: function(data) {
                    // تحديث الحالة
                    currentStatus = data.status;
                    updateStatusUI(data);

                    // إيقاف التحديث التلقائي إذا اكتملت العملية
                    if (data.status === 'completed' || data.status === 'failed') {
                        stopAutoRefresh();
                    }
                },
                error: function(xhr, status, error) {
                    console.error("Error fetching import status:", error);
                }
            });
        }

        // تحديث واجهة المستخدم
        function updateStatusUI(data) {
            // تحديث شارة الحالة
            let statusHtml = '';
            let progressValue = 0;
            let alertClass = 'alert-info';
            let statusMessage = '';

            switch(data.status) {
                case 'completed':
                    statusHtml = '<span class="badge bg-success">{% trans "مكتمل" %}</span>';
                    progressValue = 100;
                    alertClass = 'alert-success';
                    statusMessage = '{% trans "تم استيراد البيانات بنجاح!" %}';
                    break;
                case 'failed':
                    statusHtml = '<span class="badge bg-danger">{% trans "فشل" %}</span>';
                    progressValue = 100;
                    alertClass = 'alert-danger';
                    statusMessage = '{% trans "فشل استيراد البيانات. يرجى التحقق من السجل للحصول على التفاصيل." %}';
                    break;
                case 'in_progress':
                    statusHtml = '<span class="badge bg-info">{% trans "قيد المعالجة" %}</span>';
                    progressValue = calculateProgress(data.log);
                    alertClass = 'alert-info';
                    statusMessage = '{% trans "جاري معالجة الاستيراد..." %}';
                    break;
                default:
                    statusHtml = '<span class="badge bg-secondary">{% trans "معلق" %}</span>';
                    progressValue = 0;
                    alertClass = 'alert-secondary';
                    statusMessage = '{% trans "في انتظار بدء الاستيراد..." %}';
            }

            // تحديث العناصر
            $('#statusBadge').html(statusHtml);
            $('#progressBar').css('width', progressValue + '%').attr('aria-valuenow', progressValue).text(progressValue + '%');
            $('#statusMessage').removeClass('alert-info alert-success alert-danger alert-secondary').addClass(alertClass).text(statusMessage);

            // تحديث تاريخ الانتهاء
            if (data.completed_at) {
                $('#completedAt').text(formatDateTime(data.completed_at));
            }

            // تحديث سجل العملية
            if (data.log) {
                const formattedLog = formatLog(data.log);
                $('#logContainer').html(formattedLog);
                // تمرير إلى أسفل السجل
                const logContainer = document.getElementById('logContainer');
                logContainer.scrollTop = logContainer.scrollHeight;
            }

            // إظهار أزرار إضافية عند اكتمال العملية
            if (data.status === 'completed' || data.status === 'failed') {
                const actionButtons = `
                    ${data.status === 'completed' ?
                        '<a href="{% url "data_management:db_manager:db_dashboard" %}" class="btn btn-success"><i class="fas fa-check"></i> {% trans "العودة إلى لوحة التحكم" %}</a>' :
                        '<a href="{% url "data_management:db_manager:db_import" %}" class="btn btn-primary"><i class="fas fa-redo"></i> {% trans "محاولة مرة أخرى" %}</a>'}
                `;
                $('.mt-3.text-end').html(actionButtons);
            }
        }

        // حساب نسبة التقدم من السجل
        function calculateProgress(log) {
            if (!log) return 10;

            // تقدير التقدم بناءً على طول السجل ووجود كلمات رئيسية
            const totalSteps = 5; // عدد الخطوات الرئيسية في عملية الاستيراد
            let completedSteps = 0;

            if (log.includes('بدء عملية الاستيراد')) completedSteps++;
            if (log.includes('إنشاء نسخة احتياطية')) completedSteps++;
            if (log.includes('جاري التحضير لعملية الاستيراد')) completedSteps++;
            if (log.includes('بدء استيراد ملف')) completedSteps++;
            if (log.includes('تم استيراد')) completedSteps++;

            return Math.min(Math.round((completedSteps / totalSteps) * 100), 95);
        }

        // تنسيق السجل
        function formatLog(log) {
            if (!log) return '';

            // تقسيم السجل إلى أسطر
            const lines = log.split('\n');
            let formattedLog = '';

            // تنسيق كل سطر
            lines.forEach(line => {
                let lineClass = 'log-line';

                if (line.includes('خطأ') || line.includes('فشل')) {
                    lineClass += ' error';
                } else if (line.includes('تم') || line.includes('نجاح')) {
                    lineClass += ' success';
                } else if (line.includes('تحذير')) {
                    lineClass += ' warning';
                } else if (line.includes('بدء') || line.includes('جاري')) {
                    lineClass += ' info';
                }

                formattedLog += `<div class="${lineClass}">${line}</div>`;
            });

            return formattedLog;
        }

        // تنسيق التاريخ والوقت
        function formatDateTime(isoString) {
            const date = new Date(isoString);
            return date.toLocaleString('ar-EG');
        }

        // بدء التحديث التلقائي
        function startAutoRefresh() {
            autoRefresh = true;
            $('#autoRefresh').prop('checked', true);

            if (!refreshInterval) {
                refreshInterval = setInterval(function() {
                    if (autoRefresh && (currentStatus === 'in_progress' || currentStatus === 'pending')) {
                        updateImportStatus();
                    }
                }, 3000); // تحديث كل 3 ثواني
            }
        }

        // إيقاف التحديث التلقائي
        function stopAutoRefresh() {
            autoRefresh = false;
            $('#autoRefresh').prop('checked', false);

            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }

        // معالجة النقر على زر التحديث
        $('.refresh-btn').on('click', function(e) {
            e.preventDefault();
            updateImportStatus();
        });

        // معالجة تبديل التحديث التلقائي
        $('#autoRefresh').on('change', function() {
            if ($(this).is(':checked')) {
                startAutoRefresh();
            } else {
                stopAutoRefresh();
            }
        });

        // تحديث الحالة عند تحميل الصفحة
        updateImportStatus();

        // بدء التحديث التلقائي إذا كانت العملية قيد التنفيذ
        if (currentStatus === 'in_progress' || currentStatus === 'pending') {
            startAutoRefresh();
        }
    });
</script>
{% endblock %}
