{% extends 'base.html' %}
{% load i18n %}
{% load static %}

{% block title %}{% trans "إعداد النظام" %}{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">{% trans "إعداد النظام" %}</h3>
                </div>
                <div class="card-body">
                    {% if simple_setup %}
                        <div class="alert alert-info">
                            <h4>{% trans "إعداد النظام لأول مرة" %}</h4>
                            <p>{% trans "يبدو أن هذه هي المرة الأولى التي تقوم فيها بتشغيل النظام. يرجى إدخال معلومات قاعدة البيانات لإعداد النظام." %}</p>
                            {% if error %}
                                <div class="alert alert-danger">
                                    <p>{% trans "حدث خطأ أثناء محاولة الوصول إلى النظام:" %}</p>
                                    <pre>{{ error }}</pre>
                                </div>
                            {% endif %}
                        </div>
                        <form method="post" class="mt-4">
                            {% csrf_token %}
                            <h5>{% trans "معلومات قاعدة البيانات" %}</h5>
                            <div class="form-group mb-3">
                                <label for="db_type">{% trans "نوع قاعدة البيانات" %}</label>
                                <select name="db_type" id="db_type" class="form-control">
                                    <option value="postgresql" selected>PostgreSQL</option>
                                    <option value="sqlite">SQLite</option>
                                    <option value="mysql">MySQL</option>
                                </select>
                            </div>
                            <div class="form-group mb-3">
                                <label for="host">{% trans "المضيف" %}</label>
                                <input type="text" name="host" id="host" class="form-control" value="localhost">
                                <small class="form-text text-muted">{% trans "عنوان الخادم المستضيف لقاعدة البيانات (مثال: localhost)" %}</small>
                            </div>
                            <div class="form-group mb-3">
                                <label for="port">{% trans "المنفذ" %}</label>
                                <input type="text" name="port" id="port" class="form-control" value="5432">
                                <small class="form-text text-muted">{% trans "منفذ الاتصال بقاعدة البيانات (مثال: 5432 لـ PostgreSQL، 3306 لـ MySQL)" %}</small>
                            </div>
                            <div class="form-group mb-3">
                                <label for="database_name">{% trans "اسم قاعدة البيانات" %}</label>
                                <input type="text" name="database_name" id="database_name" class="form-control" value="crm">
                                <small class="form-text text-muted">{% trans "اسم قاعدة البيانات التي تريد الاتصال بها" %}</small>
                            </div>
                            <div class="form-group mb-3">
                                <label for="username">{% trans "اسم المستخدم" %}</label>
                                <input type="text" name="username" id="username" class="form-control" value="postgres">
                                <small class="form-text text-muted">{% trans "اسم المستخدم للاتصال بقاعدة البيانات" %}</small>
                            </div>
                            <div class="form-group mb-3">
                                <label for="password">{% trans "كلمة المرور" %}</label>
                                <input type="password" name="password" id="password" class="form-control">
                                <small class="form-text text-muted">{% trans "كلمة المرور للاتصال بقاعدة البيانات" %}</small>
                            </div>

                            {% if not has_users %}
                                <h5 class="mt-4">{% trans "إنشاء مستخدم مسؤول" %}</h5>
                                <div class="form-check mb-3">
                                    <input type="checkbox" name="create_admin" id="create_admin" class="form-check-input" checked>
                                    <label for="create_admin" class="form-check-label">{% trans "إنشاء مستخدم مسؤول جديد" %}</label>
                                </div>
                                <div id="admin_fields">
                                    <div class="form-group mb-3">
                                        <label for="admin_username">{% trans "اسم المستخدم" %}</label>
                                        <input type="text" name="admin_username" id="admin_username" class="form-control" value="admin">
                                    </div>
                                    <div class="form-group mb-3">
                                        <label for="admin_email">{% trans "البريد الإلكتروني" %}</label>
                                        <input type="email" name="admin_email" id="admin_email" class="form-control" value="admin@example.com">
                                    </div>
                                    <div class="form-group mb-3">
                                        <label for="admin_password">{% trans "كلمة المرور" %}</label>
                                        <input type="password" name="admin_password" id="admin_password" class="form-control" value="admin">
                                    </div>
                                </div>
                            {% endif %}

                            <div class="form-group mt-4">
                                <button type="submit" class="btn btn-primary">{% trans "إعداد النظام" %}</button>
                            </div>
                        </form>
                    {% else %}
                        <div class="alert alert-success">
                            <h4>{% trans "تم إنشاء رمز الإعداد بنجاح!" %}</h4>
                            <p>{% trans "يمكنك استخدام الرابط التالي لإعداد النظام:" %}</p>
                            <div class="input-group mb-3">
                                <input type="text" class="form-control" value="{{ setup_url }}" id="setup_url" readonly>
                                <div class="input-group-append">
                                    <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('setup_url')">{% trans "نسخ" %}</button>
                                </div>
                            </div>
                            <p>{% trans "ينتهي صلاحية هذا الرمز في:" %} {{ token.expires_at }}</p>
                        </div>
                        <div class="mt-4">
                            <a href="{% url 'accounts:login' %}" class="btn btn-primary">{% trans "العودة إلى صفحة تسجيل الدخول" %}</a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function copyToClipboard(elementId) {
        var copyText = document.getElementById(elementId);
        copyText.select();
        document.execCommand("copy");
        alert("تم نسخ الرابط: " + copyText.value);
    }

    // إظهار/إخفاء حقول المستخدم المسؤول
    $(document).ready(function() {
        $('#create_admin').change(function() {
            if(this.checked) {
                $('#admin_fields').show();
            } else {
                $('#admin_fields').hide();
            }
        });

        // تغيير الحقول المطلوبة بناءً على نوع قاعدة البيانات
        $('#db_type').change(function() {
            var dbType = $(this).val();
            if (dbType === 'sqlite') {
                $('#host, #port, #username, #password').parent().hide();
            } else {
                $('#host, #port, #username, #password').parent().show();
            }
        });
    });
</script>
{% endblock %}
