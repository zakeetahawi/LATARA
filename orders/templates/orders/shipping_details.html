{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block title %}تفاصيل الشحن - {{ order.order_number }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">تفاصيل الشحن للطلب {{ order.order_number }}</h2>
            
            <!-- معلومات الشحن الأساسية -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">معلومات الشحن الأساسية</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>العميل:</strong> {{ order.customer.name }}</p>
                            <p><strong>العنوان:</strong> {{ order.delivery_address }}</p>
                            <p><strong>المستلم:</strong> {{ shipping.recipient_name }}</p>
                            <p><strong>رقم الهاتف:</strong> {{ shipping.recipient_phone }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>شركة الشحن:</strong> {{ shipping.get_shipping_provider_display }}</p>
                            <p><strong>رقم التتبع:</strong> {{ shipping.tracking_number|default:"غير متوفر" }}</p>
                            <p><strong>تكلفة الشحن:</strong> {{ shipping.shipping_cost|default:"0" }} ريال</p>
                            <p><strong>حالة الشحن:</strong> <span id="shipping-status">{{ shipping.get_shipping_status_display }}</span></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- تحديث حالة الشحن -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">تحديث حالة الشحن</h5>
                </div>
                <div class="card-body">
                    <form id="update-status-form" method="post" action="{% url 'orders:update_shipping_status' order.id %}">
                        {% csrf_token %}
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="status">الحالة الجديدة</label>
                                    <select class="form-control" name="status" id="status" required>
                                        {% for status, label in shipping_status_choices %}
                                        <option value="{{ status }}" {% if shipping.shipping_status == status %}selected{% endif %}>
                                            {{ label }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="tracking_number">رقم التتبع</label>
                                    <input type="text" class="form-control" name="tracking_number" id="tracking_number" 
                                           value="{{ shipping.tracking_number|default:'' }}">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="estimated_delivery_date">تاريخ التوصيل المتوقع</label>
                                    <input type="datetime-local" class="form-control" name="estimated_delivery_date" 
                                           id="estimated_delivery_date" value="{{ shipping.estimated_delivery_date|date:'Y-m-d\TH:i' }}">
                                </div>
                            </div>
                        </div>
                        <div class="form-group mt-3">
                            <label for="notes">ملاحظات</label>
                            <textarea class="form-control" name="notes" id="notes" rows="3"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary mt-3">تحديث الحالة</button>
                    </form>
                </div>
            </div>

            <!-- تغيير شركة الشحن -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">تغيير شركة الشحن</h5>
                </div>
                <div class="card-body">
                    <form id="update-provider-form" method="post" action="{% url 'orders:update_shipping_provider' order.id %}">
                        {% csrf_token %}
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="provider">شركة الشحن</label>
                                    <select class="form-control" name="provider" id="provider" required>
                                        {% for provider, label in shipping_provider_choices %}
                                        <option value="{{ provider }}" {% if shipping.shipping_provider == provider %}selected{% endif %}>
                                            {{ label }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="shipping_cost">تكلفة الشحن</label>
                                    <input type="number" step="0.01" class="form-control" name="shipping_cost" 
                                           id="shipping_cost" value="{{ shipping.shipping_cost|default:'0' }}">
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary mt-3">تحديث شركة الشحن</button>
                    </form>
                </div>
            </div>

            <!-- الجدول الزمني للشحن -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">الجدول الزمني للشحن</h5>
                </div>
                <div class="card-body">
                    <div class="timeline" id="shipping-timeline">
                        {% for event in timeline %}
                        <div class="timeline-item">
                            <div class="timeline-marker"></div>
                            <div class="timeline-content">
                                <h6 class="timeline-title">{{ event.description }}</h6>
                                <p class="timeline-date">{{ event.date|date:"Y-m-d H:i" }}</p>
                            </div>
                        </div>
                        {% empty %}
                        <p>لا يوجد أحداث في الجدول الزمني حتى الآن</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<style>
    .timeline {
        position: relative;
        padding: 20px 0;
    }
    
    .timeline-item {
        position: relative;
        padding-left: 40px;
        margin-bottom: 20px;
    }
    
    .timeline-marker {
        position: absolute;
        left: 0;
        top: 0;
        width: 15px;
        height: 15px;
        border-radius: 50%;
        background-color: #007bff;
        border: 2px solid #fff;
        box-shadow: 0 0 0 2px #007bff;
    }
    
    .timeline-content {
        padding: 10px;
        border-radius: 4px;
        background-color: #f8f9fa;
    }
    
    .timeline-title {
        margin: 0;
        color: #333;
    }
    
    .timeline-date {
        margin: 5px 0 0;
        color: #666;
        font-size: 0.9em;
    }
    
    .timeline::before {
        content: '';
        position: absolute;
        left: 7px;
        top: 0;
        height: 100%;
        width: 2px;
        background-color: #007bff;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // تحديث حالة الشحن
    const updateStatusForm = document.getElementById('update-status-form');
    if (updateStatusForm) {
        updateStatusForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // تحديث العناصر في الصفحة
                    document.getElementById('shipping-status').textContent = data.shipping_status;
                    // تحديث الجدول الزمني
                    updateTimeline();
                    // عرض رسالة نجاح
                    showAlert('success', 'تم تحديث حالة الشحن بنجاح');
                } else {
                    showAlert('error', data.error || 'حدث خطأ أثناء تحديث حالة الشحن');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('error', 'حدث خطأ أثناء الاتصال بالخادم');
            });
        });
    }

    // تحديث شركة الشحن
    const updateProviderForm = document.getElementById('update-provider-form');
    if (updateProviderForm) {
        updateProviderForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // تحديث تكلفة الشحن وشركة الشحن في الصفحة
                    document.getElementById('shipping_cost').value = data.shipping_cost;
                    showAlert('success', 'تم تحديث شركة الشحن بنجاح');
                } else {
                    showAlert('error', data.error || 'حدث خطأ أثناء تحديث شركة الشحن');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('error', 'حدث خطأ أثناء الاتصال بالخادم');
            });
        });
    }

    // تحديث الجدول الزمني
    function updateTimeline() {
        fetch(`{% url 'orders:shipping_timeline' order.id %}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const timeline = document.getElementById('shipping-timeline');
                    timeline.innerHTML = '';
                    
                    data.timeline.forEach(event => {
                        const item = document.createElement('div');
                        item.className = 'timeline-item';
                        item.innerHTML = `
                            <div class="timeline-marker"></div>
                            <div class="timeline-content">
                                <h6 class="timeline-title">${event.description}</h6>
                                <p class="timeline-date">${new Date(event.date).toLocaleString()}</p>
                            </div>
                        `;
                        timeline.appendChild(item);
                    });
                }
            })
            .catch(error => console.error('Error:', error));
    }

    // عرض رسائل التنبيه
    function showAlert(type, message) {
        // يمكنك استخدام مكتبة مثل SweetAlert2 أو إنشاء عنصر تنبيه مخصص
        alert(message);
    }
});
</script>
{% endblock %}
