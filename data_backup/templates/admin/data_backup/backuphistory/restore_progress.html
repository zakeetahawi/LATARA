{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block extrastyle %}
{{ block.super }}
<style>
.progress {
    height: 25px;
    background-color: #f5f5f5;
    border-radius: 4px;
    margin: 20px 0;
    overflow: hidden;
    box-shadow: inset 0 1px 2px rgba(0,0,0,.1);
}
.progress-bar {
    height: 100%;
    background-color: #007bff;
    width: 0;
    transition: width 0.6s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    text-shadow: 1px 1px 1px rgba(0,0,0,.3);
}
.progress-bar.success {
    background-color: #28a745;
}
.progress-bar.error {
    background-color: #dc3545;
}
.status-message {
    margin: 15px 0;
    padding: 15px;
    border-radius: 4px;
    text-align: center;
    font-size: 16px;
    transition: all 0.3s ease;
}
.status-message.success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}
.status-message.error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}
.loading-spinner {
    display: inline-block;
    width: 2rem;
    height: 2rem;
    margin-right: 0.5rem;
    vertical-align: middle;
    border: 0.25rem solid currentColor;
    border-right-color: transparent;
    border-radius: 50%;
    animation: spinner-border .75s linear infinite;
}
@keyframes spinner-border {
    to { transform: rotate(360deg); }
}
.action-buttons {
    margin-top: 20px;
    text-align: center;
}
.action-buttons .btn {
    margin: 0 5px;
}
#error-details {
    display: none;
    margin-top: 15px;
    padding: 10px;
    background-color: #fff3cd;
    border: 1px solid #ffeeba;
    border-radius: 4px;
    color: #856404;
}
</style>
{% endblock %}

{% block content %}
<div class="container my-4">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title mb-0">
                <i class="fas fa-sync-alt"></i>
                {% trans "جاري استعادة قاعدة البيانات" %}
            </h3>
        </div>
        <div class="card-body">
            <div class="text-center mb-4">
                <i class="fas fa-database fa-3x text-primary"></i>
            </div>

            <div class="progress">
                <div class="progress-bar" role="progressbar" style="width: 0%;" 
                     aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
            </div>

            <div id="status-message" class="status-message">
                <div class="loading-spinner"></div>
                {% trans "جاري تحضير عملية الاستعادة..." %}
            </div>

            <div id="error-details"></div>

            <div class="action-buttons">
                <a href=".." class="btn btn-secondary" id="backButton" style="display: none;">
                    <i class="fas fa-arrow-left"></i>
                    {% trans "العودة للقائمة" %}
                </a>
                <button type="button" class="btn btn-warning" id="retryButton" style="display: none;">
                    <i class="fas fa-redo"></i>
                    {% trans "إعادة المحاولة" %}
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extrajs %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let checkInterval;
    const progressBar = document.querySelector('.progress-bar');
    const statusMessage = document.getElementById('status-message');
    const backButton = document.getElementById('backButton');
    const retryButton = document.getElementById('retryButton');
    const errorDetails = document.getElementById('error-details');
    let lastProgress = 0;
    let failedAttempts = 0;
    const MAX_ATTEMPTS = 3;

    function updateProgress() {
        fetch('{% url "admin:restore_status" %}')
            .then(response => response.json())
            .then(data => {
                // إعادة ضبط عداد المحاولات الفاشلة عند نجاح الطلب
                failedAttempts = 0;

                // تحديث شريط التقدم بشكل متدرج
                if (data.progress > lastProgress) {
                    animateProgress(lastProgress, data.progress);
                    lastProgress = data.progress;
                }

                // تحديث رسالة الحالة
                statusMessage.innerHTML = `
                    ${data.status !== 'completed' ? '<div class="loading-spinner"></div>' : ''}
                    ${data.message}
                `;

                // إدارة حالات مختلفة
                if (data.status === 'completed') {
                    handleCompletion();
                } else if (data.status === 'failed') {
                    handleFailure(data.message);
                } else if (data.status === 'error') {
                    handleError(data.message);
                }
            })
            .catch(error => {
                console.error('Error checking status:', error);
                failedAttempts++;
                
                if (failedAttempts >= MAX_ATTEMPTS) {
                    handleError('فشل الاتصال بالخادم بعد عدة محاولات');
                }
            });
    }

    function handleCompletion() {
        clearInterval(checkInterval);
        statusMessage.classList.add('success');
        backButton.style.display = 'inline-block';
        progressBar.classList.add('success');
        errorDetails.style.display = 'none';
    }

    function handleFailure(message) {
        clearInterval(checkInterval);
        statusMessage.classList.add('error');
        backButton.style.display = 'inline-block';
        retryButton.style.display = 'inline-block';
        progressBar.classList.add('error');
        errorDetails.textContent = message;
        errorDetails.style.display = 'block';
    }

    function handleError(message) {
        clearInterval(checkInterval);
        statusMessage.classList.add('error');
        backButton.style.display = 'inline-block';
        retryButton.style.display = 'inline-block';
        progressBar.classList.add('error');
        errorDetails.textContent = message;
        errorDetails.style.display = 'block';
    }

    function animateProgress(start, end) {
        const duration = 600;
        const startTime = performance.now();
        
        function update(currentTime) {
            const elapsed = currentTime - startTime;
            const progress = Math.min(elapsed / duration, 1);
            
            const current = start + (end - start) * progress;
            progressBar.style.width = current + '%';
            progressBar.setAttribute('aria-valuenow', current);
            progressBar.textContent = Math.round(current) + '%';
            
            if (progress < 1) {
                requestAnimationFrame(update);
            }
        }
        
        requestAnimationFrame(update);
    }

    // زر إعادة المحاولة
    retryButton.addEventListener('click', function() {
        location.reload();
    });

    // بدء التحقق من التقدم كل ثانيتين
    checkInterval = setInterval(updateProgress, 2000);
    // التحقق الأول مباشرة
    updateProgress();
});
</script>
{% endblock %}