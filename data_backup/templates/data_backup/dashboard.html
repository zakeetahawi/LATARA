{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}لوحة تحكم النسخ الاحتياطي{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <!-- بطاقات الإحصائيات -->
        <div class="col-xl-3 col-sm-6 mb-4">
            <div class="card">
                <div class="card-body p-3">
                    <div class="row">
                        <div class="col-8">
                            <div class="numbers">
                                <p class="text-sm mb-0 text-uppercase font-weight-bold">معدل النجاح</p>
                                <h5 class="font-weight-bolder">{{ performance_metrics.success_rate|floatformat:1 }}%</h5>
                            </div>
                        </div>
                        <div class="col-4 text-end">
                            <div class="icon icon-shape bg-gradient-primary shadow-primary text-center rounded-circle">
                                <i class="fas fa-check text-lg opacity-10" aria-hidden="true"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-sm-6 mb-4">
            <div class="card">
                <div class="card-body p-3">
                    <div class="row">
                        <div class="col-8">
                            <div class="numbers">
                                <p class="text-sm mb-0 text-uppercase font-weight-bold">إجمالي النسخ</p>
                                <h5 class="font-weight-bolder">{{ storage_report.total_backups|intcomma }}</h5>
                            </div>
                        </div>
                        <div class="col-4 text-end">
                            <div class="icon icon-shape bg-gradient-success shadow-success text-center rounded-circle">
                                <i class="fas fa-database text-lg opacity-10" aria-hidden="true"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-sm-6 mb-4">
            <div class="card">
                <div class="card-body p-3">
                    <div class="row">
                        <div class="col-8">
                            <div class="numbers">
                                <p class="text-sm mb-0 text-uppercase font-weight-bold">الحجم الإجمالي</p>
                                <h5 class="font-weight-bolder">{{ storage_report.total_size_gb|floatformat:2 }} GB</h5>
                            </div>
                        </div>
                        <div class="col-4 text-end">
                            <div class="icon icon-shape bg-gradient-warning shadow-warning text-center rounded-circle">
                                <i class="fas fa-hdd text-lg opacity-10" aria-hidden="true"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-sm-6 mb-4">
            <div class="card">
                <div class="card-body p-3">
                    <div class="row">
                        <div class="col-8">
                            <div class="numbers">
                                <p class="text-sm mb-0 text-uppercase font-weight-bold">متوسط الوقت</p>
                                <h5 class="font-weight-bolder">{{ performance_metrics.avg_backup_time|floatformat:1 }} ثانية</h5>
                            </div>
                        </div>
                        <div class="col-4 text-end">
                            <div class="icon icon-shape bg-gradient-info shadow-info text-center rounded-circle">
                                <i class="fas fa-clock text-lg opacity-10" aria-hidden="true"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- الرسوم البيانية -->
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">نجاح وفشل النسخ الاحتياطي</h5>
                    <a href="{% url 'data_backup:backup_reports' 'daily' %}" class="btn btn-sm btn-primary">عرض التقارير</a>
                </div>
                <div class="card-body">
                    <div id="successFailureChart"></div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">حجم النسخ الاحتياطي</h5>
                    <a href="{% url 'data_backup:backup_metrics' %}" class="btn btn-sm btn-primary">عرض المقاييس</a>
                </div>
                <div class="card-body">
                    <div id="sizeChart"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- إعدادات التخزين السحابي -->
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">إعدادات التخزين السحابي</h5>
                    <a href="{% url 'data_backup:cloud_storage_settings' %}" class="btn btn-primary btn-sm">تعديل الإعدادات</a>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <tbody>
                                <tr>
                                    <th>نوع التخزين:</th>
                                    <td>{{ cloud_config.get_storage_type_display }}</td>
                                    <th>حالة التفعيل:</th>
                                    <td>{% if cloud_config.is_active %}<span class="badge bg-success">مفعل</span>{% else %}<span class="badge bg-warning">غير مفعل</span>{% endif %}</td>
                                </tr>
                                <tr>
                                    <th>الرفع التلقائي:</th>
                                    <td>{% if cloud_config.auto_upload %}<span class="badge bg-success">مفعل</span>{% else %}<span class="badge bg-warning">غير مفعل</span>{% endif %}</td>
                                    <th>فترة الاحتفاظ:</th>
                                    <td>{{ cloud_config.retention_period }} يوم</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- مزامنة جداول بيانات Google -->
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">مزامنة جداول بيانات Google</h5>
                    <div>
                        <a href="{% url 'data_backup:update_sync_interval' %}" class="btn btn-primary btn-sm ms-2">تعديل فترة المزامنة</a>
                        <a href="{% url 'data_backup:import_from_sheets' %}" class="btn btn-info btn-sm ms-2">استيراد من Google Sheets</a>
                        <form method="post" action="{% url 'data_backup:sync_now' %}" class="d-inline">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-success btn-sm">مزامنة الآن</button>
                        </form>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <tbody>
                                <tr>
                                    <th>حالة المزامنة:</th>
                                    <td>{% if config.is_active %}<span class="badge bg-success">مفعلة</span>{% else %}<span class="badge bg-danger">غير مفعلة</span>{% endif %}</td>
                                    <th>آخر مزامنة:</th>
                                    <td>{{ config.last_sync|default:"لم يتم المزامنة بعد"|date:"Y-m-d H:i" }}</td>
                                </tr>
                                <tr>
                                    <th>فترة المزامنة:</th>
                                    <td>{{ config.sync_interval_minutes }} دقيقة</td>
                                    <th>معرف الجدول:</th>
                                    <td>{{ config.spreadsheet_id|truncatechars:20 }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <h6 class="mt-4">آخر عمليات المزامنة</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>التاريخ</th>
                                    <th>الحالة</th>
                                    <th>السجلات</th>
                                    <th>المستخدم</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for log in recent_logs %}
                                <tr>
                                    <td>{{ log.timestamp|date:"Y-m-d H:i" }}</td>
                                    <td>
                                        {% if log.status == 'success' %}
                                            <span class="badge bg-success">ناجحة</span>
                                        {% elif log.status == 'partial' %}
                                            <span class="badge bg-warning">جزئية</span>
                                        {% else %}
                                            <span class="badge bg-danger">فاشلة</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ log.records_synced }}</td>
                                    <td>{% if log.triggered_by %}{{ log.triggered_by.get_full_name|default:log.triggered_by.username }}{% else %}نظام{% endif %}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center">لا توجد سجلات مزامنة</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- آخر النسخ الاحتياطية -->
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">آخر النسخ الاحتياطية</h5>
                    <div>
                        <form method="post" action="{% url 'data_backup:create_backup' %}" class="d-inline" id="createBackupForm">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-success btn-sm me-2" id="createBackupBtn">
                                <i class="fas fa-plus-circle"></i> إنشاء نسخة جديدة
                            </button>
                        </form>
                        <a href="{% url 'data_backup:restore_backup' %}" class="btn btn-warning btn-sm">
                            <i class="fas fa-undo"></i> استعادة نسخة
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>التاريخ</th>
                                    <th>النوع</th>
                                    <th>الحالة</th>
                                    <th>الحجم</th>
                                    <th>المستخدم</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for backup in recent_backups %}
                                <tr>
                                    <td>{{ backup.timestamp|date:"Y-m-d H:i" }}</td>
                                    <td>{{ backup.get_backup_type_display }}</td>
                                    <td>
                                        {% if backup.status == 'success' %}
                                            <span class="badge bg-success">{{ backup.get_status_display }}</span>
                                        {% elif backup.status == 'failed' %}
                                            <span class="badge bg-danger">{{ backup.get_status_display }}</span>
                                        {% else %}
                                            <span class="badge bg-info">{{ backup.get_status_display }}</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ backup.get_file_size_display }}</td>
                                    <td>{% if backup.created_by %}{{ backup.created_by.get_full_name|default:backup.created_by.username }}{% else %}نظام{% endif %}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center">لا توجد نسخ احتياطية حتى الآن</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- نافذة تأكيد النسخ الاحتياطي -->
<div class="modal fade" id="backupConfirmModal" tabindex="-1" aria-labelledby="backupConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="backupConfirmModalLabel">تأكيد إنشاء نسخة احتياطية</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
            </div>
            <div class="modal-body">
                هل أنت متأكد من إنشاء نسخة احتياطية جديدة؟ قد تستغرق هذه العملية بعض الوقت اعتمادًا على حجم البيانات.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                <button type="button" class="btn btn-success" id="confirmBackupBtn">إنشاء النسخة</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
    // تهيئة الرسوم البيانية
    document.addEventListener('DOMContentLoaded', function() {
        // رسم بياني للنجاح والفشل
        var successFailureData = {{ daily_report.charts.success_failure|safe }};
        Plotly.newPlot('successFailureChart', JSON.parse(successFailureData));
        
        // رسم بياني للحجم
        var sizeData = {{ daily_report.charts.size|safe }};
        Plotly.newPlot('sizeChart', JSON.parse(sizeData));

        // معالجة أزرار النسخ الاحتياطي
        var backupForm = document.getElementById('createBackupForm');
        var createBackupBtn = document.getElementById('createBackupBtn');
        
        // نوقف الإرسال المباشر للنموذج ونظهر نافذة التأكيد
        backupForm.addEventListener('submit', function(event) {
            event.preventDefault();
            var backupConfirmModal = new bootstrap.Modal(document.getElementById('backupConfirmModal'));
            backupConfirmModal.show();
        });
        
        // عند النقر على زر التأكيد في النافذة المنبثقة، نقوم بإرسال النموذج
        document.getElementById('confirmBackupBtn').addEventListener('click', function() {
            backupForm.submit();
        });
    });
</script>
{% endblock %}